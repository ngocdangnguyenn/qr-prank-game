<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt Qu·∫£</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="game-element cloud cloud1"></div>
    <div class="game-element cloud cloud2"></div>
    <div class="game-element cloud cloud3"></div>
    <div class="game-element block block1"></div>
    <div class="game-element block block2"></div>
    <div class="game-element coin coin1"></div>
    <div class="game-element coin coin2"></div>
    <div class="game-element coin coin3"></div>

    <div class="container">
        <div class="card result-card">
            <div class="prank-reveal">
                <h1 class="prank-title">üòÜ C√ö L·ª™A R·ªíI NH√â!</h1>
                <p class="prank-message">Tr√≤ ch∆°i n√†y kh√¥ng h·ªÅ t·ªìn t·∫°i.<br>Kh√¥ng nh·∫≠n ƒë∆∞·ª£c qu√† ƒë√¢u b·∫°n!</p>
                <div class="prank-emoji">ü§£üòÇü§™</div>
            </div>
            
            <div class="leaderboard-section">
                <h2 class="leaderboard-title">TOP 10 NG∆Ø·ªúI ƒê·∫¶U TI√äN B·ªä L·ª™A</h2>
                
                <div class="table-container">
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>ü•á H·∫°ng</th>
                                <th>üë§ H·ªç v√† T√™n</th>
                                <th>‚è∞ Th·ªùi Gian</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                </div>
                
                <div class="player-status" id="playerStatus"></div>
            </div>
            
            <div class="action-buttons">
                <button onclick="playAgain()" class="btn-primary">Ch∆°i L·∫°i</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, query, orderByChild } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAAsPo3oAErT9Fw6UuZRxZu30EKkzxMkJc",
            authDomain: "qr-prank-game.firebaseapp.com",
            databaseURL: "https://qr-prank-game-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "qr-prank-game",
            storageBucket: "qr-prank-game.firebasestorage.app",
            messagingSenderId: "154352199581",
            appId: "1:154352199581:web:4526715feaa6f802517174"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        const currentPlayer = sessionStorage.getItem('currentPlayer');
        
        if (!currentPlayer) {
            window.location.href = 'index.html';
        }
        
        let gameStatus = 'active';
        const gameStatusRef = ref(database, 'gameStatus');
        
        onValue(gameStatusRef, (snapshot) => {
            gameStatus = snapshot.val() || 'active';
            loadLeaderboard();
        });
        
        function loadLeaderboard() {
            const playersRef = ref(database, 'players');
            const playersQuery = query(playersRef, orderByChild('timestamp'));
            
            onValue(playersQuery, (snapshot) => {
                const players = [];
                snapshot.forEach((childSnapshot) => {
                    players.push(childSnapshot.val());
                });
                
                const leaderboardBody = document.getElementById('leaderboardBody');
                const leaderboardTitle = document.querySelector('.leaderboard-title');
                
                leaderboardBody.innerHTML = '';
                
                if (gameStatus === 'ended') {
                    leaderboardTitle.textContent = 'B·∫¢NG X·∫æP H·∫†NG T·∫§T C·∫¢ NG∆Ø·ªúI CH∆†I';
                    displayFullLeaderboard(players);
                } else {
                    leaderboardTitle.textContent = 'K·∫æT QU·∫¢ C·ª¶A B·∫†N';
                    displayPlayerRankOnly(players);
                }
            });
        }
        
        function displayPlayerRankOnly(players) {
            const leaderboardBody = document.getElementById('leaderboardBody');
            const playerStatus = document.getElementById('playerStatus');
            const playerIndex = players.findIndex(p => p.name === currentPlayer);
            
            leaderboardBody.innerHTML = '';
            document.querySelector('.table-container').style.display = 'none';
            document.querySelector('.leaderboard-section h2').style.display = 'none';
            
            if (playerIndex === -1) {
                playerStatus.innerHTML = '<div class="status-message">Kh√¥ng t√¨m th·∫•y th√¥ng tin c·ªßa b·∫°n!</div>';
                return;
            }
            
            const rank = playerIndex + 1;
            
            playerStatus.innerHTML = `
                <div class="status-message" style="background: #ff69b4; padding: 20px 30px; border-radius: 8px; text-align: center; margin: 20px 0; box-shadow: 0 4px 15px rgba(255,105,180,0.4);">
                    <div style="font-size: 1.3em; font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">B·∫°n l√† ng∆∞·ªùi th·ª© ${rank} b·ªã l·ª´a! üòä</div>
                </div>
            `;
        }
        
        function displayFullLeaderboard(players) {
            const leaderboardBody = document.getElementById('leaderboardBody');
            const playerStatus = document.getElementById('playerStatus');
            
            document.querySelector('.table-container').style.display = 'block';
            document.querySelector('.leaderboard-section h2').style.display = 'block';
            
            if (players.length === 0) {
                leaderboardBody.innerHTML = '<tr><td colspan="3" class="no-data">Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o!</td></tr>';
                return;
            }
            
            players.forEach((player, index) => {
                const row = document.createElement('tr');
                
                if (index === 0) row.classList.add('rank-1');
                else if (index === 1) row.classList.add('rank-2');
                else if (index === 2) row.classList.add('rank-3');
                
                if (player.name === currentPlayer) {
                    row.classList.add('current-player');
                }
                
                let rankDisplay = index + 1;
                if (index === 0) rankDisplay = 'ü•á 1';
                else if (index === 1) rankDisplay = 'ü•à 2';
                else if (index === 2) rankDisplay = 'ü•â 3';
                
                row.innerHTML = `
                    <td>${rankDisplay}</td>
                    <td>${player.name}${player.name === currentPlayer ? ' <span class="you-badge">B·∫†N</span>' : ''}</td>
                    <td>${player.timestampDisplay}</td>
                `;
                
                leaderboardBody.appendChild(row);
            });
            
            playerStatus.innerHTML = '';
        }
        
        sessionStorage.setItem('refreshCount', '0');
        
        window.playAgain = function() {
            sessionStorage.removeItem('currentPlayer');
            sessionStorage.setItem('refreshCount', '0');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
